# Plural - AI Assistant for Kids

Plural is a web application designed as an AI companion for children (ages 6-12), supervised by parents. It allows kids to explore topics and ask questions using text and images in persistent conversation threads called "Quests".

## Features

*   **Parent Authentication:** Secure signup and signin for parents using Supabase Auth.
*   **Quest Management:**
    *   Create new quests from the dashboard using text or image prompts.
    *   View existing quests displayed as dynamic icons on the dashboard.
    *   Delete quests (including associated messages).
*   **Conversational AI:**
    *   Engage in conversations within each quest.
    *   AI responses generated by Google Gemini Flash (`gemini-2.0-flash`).
    *   Contextual memory using vector similarity search (Supabase pgvector) combined with recent message history.
    *   Customizable AI persona/system prompt via the "Guide" page.
*   **Multimodal Input:** Ask questions using text or by uploading images (supports camera/gallery on mobile).
*   **Image Handling:**
    *   Client-side image compression before upload.
    *   Images stored in Supabase Storage.
    *   Images displayed as clickable thumbnails in chat, opening an enlarged view.
*   **AI Follow-up Suggestions:** AI suggests relevant next questions after its response, which can be clicked to continue the conversation.
*   **Realtime Updates:** New AI messages and suggestions appear automatically without manual refresh.
*   **UI Elements:** Includes logo, styled quest icons, Markdown rendering, copy button, loading indicators.
*   **Deployment Ready:** Nginx configuration for reverse proxy (HTTP/HTTPS) and systemd service files included for persistent background operation.

## Tech Stack

*   **Frontend:** Next.js (App Router), React, TypeScript, Tailwind CSS
*   **Backend:** Python, FastAPI, Uvicorn
*   **Database:** Supabase (Postgres) with pgvector extension
*   **Authentication:** Supabase Auth
*   **Storage:** Supabase Storage
*   **AI Models:**
    *   Chat: Google Gemini Flash (`gemini-2.0-flash`) via `google-generativeai` library
    *   Embeddings: Google `text-embedding-004` via `google-generativeai` library
    *   Image Generation: Placeholder (can be integrated with Imagen, DALL-E, Stability AI etc.)
*   **Deployment:** Nginx, systemd (setup provided)

## Project Structure

```
/
├── backend/            # FastAPI backend application
│   ├── .venv/          # Python virtual environment
│   ├── .env            # Backend environment variables (Supabase keys, Google API key)
│   ├── main.py         # FastAPI app definition and endpoints
│   ├── llm.py          # AI model interaction logic (Gemini chat, embeddings, suggestions)
│   ├── database.py     # Supabase database interaction (CRUD, RPC calls)
│   ├── schemas.py      # Pydantic data models
│   ├── auth.py         # FastAPI authentication dependency
│   ├── clients.py      # Supabase client initialization
│   └── config.py       # Environment variable loading
├── frontend/           # Next.js frontend application
│   ├── public/         # Static assets (e.g., plural_logo.png)
│   ├── app/            # Next.js App Router pages and layouts
│   ├── components/     # React components (ChatInput, ChatMessages, QuestIcon, etc.)
│   ├── lib/            # Utility functions (e.g., Supabase client setup)
│   ├── .env.local      # Frontend environment variables (Supabase URL/Anon key, App URL)
│   ├── next.config.ts  # Next.js configuration (including image domains)
│   └── ...             # Other Next.js files (package.json, tsconfig.json, etc.)
├── backend.service     # systemd service file for backend
├── frontend.service    # systemd service file for frontend
├── plural.nginx.conf   # Nginx configuration snippet
└── README.md           # This file
```

## Setup

1.  **Clone Repository:** `git clone https://github.com/YOUR_USERNAME/plural-edtech.git` (Replace YOUR_USERNAME)
2.  **Supabase Setup:**
    *   Create a Supabase project.
    *   In **SQL Editor**, enable the `vector` extension: `create extension if not exists vector with schema extensions;`
    *   Run the SQL commands provided in `backend/database_schema.sql` (or steps from development history) to create the `quests` and `messages` tables (including the `embedding vector(768)` and `metadata jsonb` columns) and the required database functions (`match_quest_messages`, `get_user_quests_with_counts`). Ensure RLS is enabled and policies are set correctly for both tables.
    *   Create a **public** Storage bucket named `quest-images`.
    *   Add Storage policies to allow authenticated users to `insert`, `select`, `update`, `delete` files within their own user ID folder (e.g., `(bucket_id = 'quest-images') AND ((storage.foldername(name))[1] = (auth.uid())::text)` for both `USING` and `WITH CHECK` expressions).
    *   Optionally disable "Confirm email" in Supabase Auth settings if you don't want email verification.
3.  **Environment Variables:**
    *   **Backend (`backend/.env`):**
        *   `SUPABASE_URL`: Your Supabase project URL.
        *   `SUPABASE_SERVICE_KEY`: Your Supabase **service role** key (secret).
        *   `GOOGLE_API_KEY`: Your Google AI Studio or Google Cloud API key for Gemini and Embeddings.
    *   **Frontend (`frontend/.env.local`):**
        *   `NEXT_PUBLIC_SUPABASE_URL`: Your Supabase project URL.
        *   `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Your Supabase **anon public** key.
        *   `NEXT_PUBLIC_APP_URL`: The full base URL where the frontend will be hosted (e.g., `https://plural.dexterslab.site`). Used for server-side API calls.
        *   `NEXT_PUBLIC_BACKEND_URL`: The relative path for client-side API calls (usually `/api` if using the provided Nginx proxy).
4.  **Backend Dependencies:**
    ```bash
    cd backend
    python3 -m venv .venv
    source .venv/bin/activate
    pip install fastapi uvicorn[standard] supabase httpx google-generativeai Pillow python-dotenv PyJWT
    ```
5.  **Frontend Dependencies:**
    ```bash
    cd frontend
    npm install
    ```
6.  **Logo:** Place your logo file as `frontend/public/plural_logo.png`.

## Running Locally (Development)

1.  **Start Backend:**
    ```bash
    cd backend
    source .venv/bin/activate
    uvicorn main:app --reload --port 8000
    ```
2.  **Start Frontend:**
    ```bash
    cd frontend
    npm run dev # Usually runs on port 3000 or next available
    ```
3.  Access via `http://localhost:3000` (or the port specified by `npm run dev`). Nginx is not required for local development access via localhost.

## Running Persistently (Deployment with systemd & Nginx)

1.  **Build Frontend:**
    ```bash
    cd frontend
    npm run build
    ```
2.  **Configure Nginx:**
    *   Copy the provided `plural.nginx.conf` content to `/etc/nginx/sites-available/your_domain.conf` (e.g., `plural.dexterslab.site`).
    *   Ensure `server_name` matches your domain.
    *   Ensure `proxy_pass` for the `/` location points to the correct frontend port (e.g., `http://localhost:3000`).
    *   Ensure `proxy_pass` for the `/api/` location points to the correct backend port (e.g., `http://localhost:8000/`).
    *   Create symlink: `sudo ln -s /etc/nginx/sites-available/your_domain.conf /etc/nginx/sites-enabled/`
    *   Test config: `sudo nginx -t`
    *   Reload/Restart Nginx: `sudo systemctl reload nginx` or `sudo systemctl restart nginx`
3.  **Setup HTTPS (Certbot):**
    *   Install Certbot: `sudo apt update && sudo apt install certbot python3-certbot-nginx -y`
    *   Run Certbot: `sudo certbot --nginx -d your_domain.com` (follow prompts, choose redirect)
4.  **Setup systemd Services:**
    *   Edit `backend.service` and `frontend.service` to ensure `User`, `Group`, `WorkingDirectory`, and `ExecStart` paths/ports are correct for your setup.
    *   Copy services:
        ```bash
        sudo cp backend.service /etc/systemd/system/plural-backend.service
        sudo cp frontend.service /etc/systemd/system/plural-frontend.service
        ```
    *   Reload, enable, and start:
        ```bash
        sudo systemctl daemon-reload
        sudo systemctl enable plural-backend.service plural-frontend.service
        sudo systemctl start plural-backend.service plural-frontend.service
        ```
    *   Check status: `sudo systemctl status plural-backend.service plural-frontend.service`
5.  Access via `https://your_domain.com`.